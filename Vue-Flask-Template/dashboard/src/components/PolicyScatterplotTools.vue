<script lang="ts">
import * as d3 from "d3";
import { isEmpty, debounce } from 'lodash';
import * as d3Slider from 'd3-simple-slider';

// Computed property: https://vuejs.org/guide/essentials/computed.html
// Lifecycle in vue.js: https://vuejs.org/guide/essentials/lifecycle.html#lifecycle-diagram
// For importing a store. See how it's set up in ./dashboard/stores/ and ./dashboard/main.ts
import { mapState, storeToRefs } from 'pinia';
import { useDataStore } from '../stores/dataStore';

export default {
    setup() { // Composition API syntax
        const store = useDataStore()
        // Alternative expression from computed
        const { resize } = storeToRefs(store);
        const { size } = storeToRefs(store);
        const { margin } = storeToRefs(store);

        return {
            store, // Return store as the local state, but when you update the property value, the store is also updated.
            resize,
            size,
            margin
        }
    },
    computed: {
        ...mapState(useDataStore, []) // Traditional way to map the store state to the local state
    },
    created() {
    },
    methods: {
        onResize() {  // record the updated size of the target element
            console.log('resize')
            let target = this.$refs.scatterToolsContainer as HTMLElement
            if (!target) return;
            this.size = { width: target.clientWidth, height: target.clientHeight };
        },
        initChart() {
            // select the svg tag so that we can insert(render) elements, i.e., draw the chart, within it.
            let sc = this.$refs.scatterToolsContainer as HTMLElement;

            let svg = d3.select('.scatter-tools-container')
                .append('svg')
                .attr('id', 'scatter-tools-svg')
                .attr('width', '100%')
                .attr('height', '100%')

            // get the size of the parent container
            const parentRect = { width: sc.clientWidth, height: sc.clientHeight };

            // update the viewBox attribute based on the size of the parent container
            // svg.attr('viewBox', `${this.margin.left} ${this.margin.top} ${parentRect.width} ${parentRect.height }`);

            
            const slider = d3Slider
                .sliderRight()
                .min(2)
                .max(6)
                .width(parentRect.height) // Adjust the height based on the parent container
                .ticks(5)
                .tickFormat(d3.format(',.0f'))
                .step(1)
                .default(3)
                // .fill('#2196f3')
                .on('end', val => {
                    console.log('Slider value:', val);
                })
                ;


                const centerX = (parentRect.width / 2) - this.margin.right;
                const centerY = parentRect.height - parentRect.height + this.margin.top + this.margin.bottom;




                const sliderGroup = svg
                    .append('g')
                    .attr('transform', `translate(${centerX}, ${centerY})`)
                    .call(slider);



            svg.append('g').append('text') // adding the text
                .attr('transform', `translate(${centerX}, ${centerY - this.margin.top})`)
                .style('text-anchor', 'middle')
                .style('font-weight', 'bold')
                .style('font-size', '12px') 
                .text('Clusters') // text content


        },
        rerender() {
            d3.selectAll('.scatter-tools-container').selectAll('*').remove() // Clean all the elements in the chart
            this.initChart()
        }

    },
    watch: {
        resize(newSize) { // when window resizes
            console.log('watch')
            if ((newSize.width !== 0) && (newSize.height !== 0)) {
                this.rerender()
            }
        },
    },
    // The following are general setup for resize events.
    mounted() {
        window.addEventListener('resize', debounce(this.onResize, 100))
        this.onResize()
    },
    beforeDestroy() {
        window.removeEventListener('resize', this.onResize)
    }
}
</script>

<!-- "ref" registers a reference to the HTML element so that we can access it via the reference in Vue.  -->
<!-- We use flex to arrange the layout-->
<template>
    <div class="scatter-tools-container d-flex" ref="scatterToolsContainer">

    </div>
</template>

<style scoped>
.slider-group {
    transform-origin: top left;
    transform: rotate(90deg) translateY(-100%);
}

.scatter-tools-container {
    height: calc(100%);
}
</style>